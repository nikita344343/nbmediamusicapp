# Все плагины: что делают и как связать с приложением

Сводка по папке **«Все плагины»** и что нужно для Android-приложения (REST API).

---

## Список плагинов (14 шт.)

| Плагин | Назначение |
|--------|------------|
| **nb-music-catalog** | Каталог релизов артиста: карточки релизов, треклист, статусы (одобрен/черновик/выпущен), стримы по релизам, промо-форма, история изменений. Данные — посты (`post`) + мета (artist_info, upc_code, date_relise и т.д.). Статистика подтягивается из таблицы `wp_track_stats`. |
| **track_stats_plugin prod** | Статистика: DMB API (синхронизация по датам) + ручной ввод. Хранит данные в `wp_track_stats`. Shortcode `[track_stats]` — дашборд (графики, платформы, треки). Cron для авто-синка. |
| **nb-music-submission** | Форма загрузки аудио-релизов (сингл/EP/альбом), оплата (ЮKassa), черновики, баллы. Всё через AJAX (admin-ajax.php). |
| **nb-media-dashboard** | Личный кабинет: шапка, навигация, посты/страницы, поиск. Модули: api-search, form-handler, post-type и т.д. |
| **nb-media-feed** | Лента/фид контента (уточняется по коду). |
| **nb-video-submission** | Загрузка видео-релизов. |
| **nb-videoshot-submission** | Загрузка видео-шотов. |
| **nb-support-tickets** | Тикеты поддержки. |
| **nbmedia-notifications** | Уведомления. |
| **nbmedia-pay** | Оплата/каталог услуг (фильтр `nbmedia_pay_get_products`, `nbmedia_pay_store_url`). |
| **nbmusic-contract-flow** | Оформление договоров. |
| **nb-market-beat** | Маркет/бит (связан с ЮKassa через общие ключи в nb-music-submission). |
| **dmb-smart-links** | Умные ссылки (вероятно, DMB/лендинги). |
| **Track Reports** | Финансовые отчёты (Track Report Manager), кинематографический стиль. |

---

## Есть ли REST API в этих плагинах?

**Нет.** Во всех плагинах используется только:

- **Shortcodes** — вывод блоков на сайте (каталог, статистика, форма загрузки и т.д.).
- **AJAX через `admin-ajax.php`** — действия с фронта (сохранение, удаление, синхронизация, промо, загрузка). Запросы идут на `admin_url('admin-ajax.php')` с `action` и `nonce`.

То есть **отдельных REST API endpoints** (типа `/wp-json/...`) в твоих плагинах **нет**. Стандартный WordPress REST API (`/wp-json/wp/v2/posts` и т.д.) даёт только базовые поля постов, без твоих мета (artist_name, upc_code, artist_info, стримы и т.д.).

---

## Что нужно для Android-приложения

Чтобы приложение могло показывать каталог, статистику и (при желании) загрузку — на стороне WordPress нужно **добавить REST API**.

### 1. Что уже есть в WordPress «из коробки»

- **URL:** `https://ТВОЙ-САЙТ.ru/wp-json/`
- **Посты:** `GET /wp/v2/posts` — список постов. По умолчанию **без** кастомных полей (artist_name, upc, artist_info, дата релиза, статус и т.д.).
- **Медиа:** `GET /wp/v2/media`, `POST /wp/v2/media` (для загрузки нужна авторизация).
- **Пользователи:** `GET /wp/v2/users` (зависит от настроек и прав).

Этого недостаточно для «каталога как на сайте» и для статистики из `wp_track_stats`.

### 2. Что нужно добавить (плагин «REST API для приложения»)

Имеет смысл сделать **один небольшой плагин** (или раздел в существующем), который зарегистрирует REST API endpoints и будет:

- **Отдавать каталог релизов текущего пользователя**  
  По сути — посты автора + нужные мета (название релиза, артист, дата, UPC, жанр, треклист из `artist_info`, обложка, статус). Авторизация — по Cookie или по Application Passwords / JWT.

- **Отдавать статистику по пользователю**  
  Чтение из таблицы `wp_track_stats` за период (агрегаты по трекам, по платформам, общие цифры). Только для залогиненного пользователя (`user_id`).

- **Загрузка треков**  
  Либо вызов стандартного `POST /wp/v2/media` с авторизацией (Application Passwords), либо свой endpoint, который внутри создаёт вложение и привязывает к черновику поста (как делает nb-music-submission через AJAX). Второй вариант ближе к текущей логике сайта.

### 3. Где что взять в коде (для того, кто будет писать плагин)

- **Каталог (поля релиза):**  
  - Посты: `post_type = 'post'`, автор = текущий пользователь.  
  - Мета: из **nb-music-catalog** — `realise_namee` / `release_name`, `artist_nameee` / `artist_name`, `date_relise` / `release_date`, `upc_code`, `upc_video`, `nb_upc`, `genre`, `artist_info` (треклист), `_nb_is_deleted`, обложка — `get_the_post_thumbnail_url()`.  
  - Агрегат стримов по релизу уже считается в `nb-music-catalog` через `get_accumulated_stats()` (таблица `wp_track_stats`). Эту же логику можно вызвать в REST и отдать в ответе.

- **Статистика:**  
  - Таблица: `$wpdb->prefix . 'track_stats'`.  
  - Поля: `user_id`, `track_name`, `track_version`, `plays`, `platform`, `import_date` и т.д.  
  - В **track_stats_plugin** уже есть выборки по `user_id` и датам в shortcode `[track_stats]` — можно вынести в отдельные функции и вызывать из REST.

- **Авторизация в REST:**  
  - Application Passwords (Профиль пользователя → Пароли приложений) — логин + пароль приложения в заголовке.  
  - Либо JWT-плагин: приложение сначала получает токен по логину/паролю, потом шлёт `Authorization: Bearer <token>`.

### 4. Краткий чек-лист

1. **Проверить стандартный API:** открыть в браузере `https://ТВОЙ-САЙТ.ru/wp-json/wp/v2/posts`. Если видишь JSON — REST включён.
2. **Включить Application Passwords** (если нужна загрузка/личные данные): Пользователи → свой профиль → «Пароли приложений».
3. **Написать плагин** с `register_rest_route()`:
   - например, `GET /wp-json/nb-app/v1/catalog` — каталог релизов текущего пользователя (с мета и стримами);
   - `GET /wp-json/nb-app/v1/stats` — статистика из `wp_track_stats` за период;
   - при необходимости — `POST /wp-json/nb-app/v1/...` для загрузки (или использование `/wp/v2/media`).
4. **В приложении** дергать эти endpoints с авторизацией (логин + Application Password или JWT).

---

## Итог

- **Все плагины** работают через shortcodes и **admin-ajax.php**, не через REST API.
- Для приложения нужен **отдельный REST API**: один маленький плагин (или модуль), который даёт каталог релизов, статистику и при необходимости загрузку.
- **Где что взять:** каталог и мета — из **nb-music-catalog**, статистика — из **track_stats_plugin** и таблицы `wp_track_stats`, авторизация — стандартные средства WordPress (Application Passwords или JWT).

Если скажешь, на чём удобнее писать (отдельный плагин или расширение nb-music-catalog / track_stats), могу расписать конкретные имена функций и примеры `register_rest_route` под твой сайт.
